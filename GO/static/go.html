<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>GoGame</title>

	<script id="jquery_172" type="text/javascript" class="library"
	        src="https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
	<style>html, * {
		-webkit-user-select: text !important;
		-moz-user-select: text !important;
	}</style>
	<style type="text/css">
		.game_info{
			text-align: center;
			color:black;
			position: fixed;
			top: 80px;
			left: 50px;
			width: 300px;
			font-size: 15px;
			font-family: "微软雅黑 Light";
		}
		.user_information{
			position: absolute;
			right: 0px;
			top:0px;
			color: black;
			font-family: 微软雅黑;
		}
		div div a:link{
			color: black;
		}
		div div a:active{
			color: black;
		}
		div div a:hover{
			color: black;
		}
	</style>
	<link href="{{url_for("static", filename="css/stylesheet.css")}}" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"
	      integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<script type="text/javascript" src="https://cdn.bootcss.com/socket.io/1.5.1/socket.io.min.js"></script>
	<script type="text/javascript">
		function mouseOver()
		{
			document.getElementById("haha").src = "{{ url_for("static",filename = "img/GroupBlack.png")}}"
		}
		function mouseout()
		{
			document.getElementById("haha").src = "{{ url_for("static",filename = "img/Group.png")}}"
		}
	</script>



	<script type="text/javascript" src="{{url_for('static',filename='js/tenuki.js')}}"></script>
	<link href="{{url_for("static", filename="css/tenuki.css")}}" rel="stylesheet" type="text/css">

	<!--<script href="{{ url_for('static',filename='js/user.js') }}" type="text/javascript"></script>-->
</head>
<body class="Body1">

<div class="Backg" style="background-image:url(static/img/Go.png);">
	<div id="login_reg" class="user_information">
		<button class="btn" onclick="window.location.href='/login'">登录</button>
		<button class="btn" onclick="window.location.href='/register'">注册</button>
	</div>
	<div id="user_information" class="user_information">
		<a id="user_id_display" style="font-size: 20px;"></a>
		<button class="btn" onclick="window.location.href='/information'">个人中心</button>
		<button class="btn" onclick="logout()">登出</button>
	</div>
	<br>
	<div id="mydiv">

		<div class="title">
			<p>围棋测试1.0&nbsp;</p>
		</div>
		<div>
			<!--TODO 表单样式可以改CSS使其更美观 -->

			<form id="user_data" target="rfFrame" class="username">

				<!--用户ID:-->
				<input type="text" name="user_id" id="user_id"  readonly="readonly" style="display:none;">
				<!--&lt;!&ndash;style="background-image: url(static/img/Rectangle.png);"&ndash;&gt;-->

				<!--<br>-->
				游戏ID:
				<input type="text" name="game_id" id="game_id" ><!--style="background-image: url(static/img/Rectangle.png);"-->
				<!--<img src="Rectangle 2.png" class="rec1">
				<img src="Rectangle 2.png" class="rec2">-->
				<br>
				<a href="javascript:" onclick="submit_id()">
					<img src="{{url_for("static",filename="img/Group.png")}}"
					width="36" height="36" id="haha" onmouseover="mouseOver()" onmouseout="mouseout()"
					style="float:inherit;margin-left: 18px;margin-top: 10px"></a>
				<!--<input type="submit" value="创建或加入游戏" class="bt1" style="background-color:transparent;background-image:url("Group.png");"  width="45" height="45" alt="" >-->
			</form>
		</div>
		<!--显示对局信息 -->
		<div id="gameinfo" class="info"></div>

		<!-- TODO 显示对局消息 要用更好的方法实现-->
		<div id="message" class="message">
			收到的消息
			<div id="gamemessage">

			</div>
		</div>
		<!-- TODO 显示系统消息-->
		<div class="systemmessage">
			系统消息
			<div id="player_side">

			</div>
			<div id="system_message">

			</div>
		</div>
		<iframe id="rfFrame" name="rfFrame" src="about:blank" style="display:none;"></iframe>



		<div class="tenuki-board tenuki-board-textured" style="align-content: center;margin: auto"></div>



		<div>

			<form id="sendmessage" target="rfFrame">
				<input type="text" name="game_message" id="game_message">
				<input type="submit" value="发送消息">
			</form>
		</div>

	</div>

	<div id="game_info" class="game_info well">
		<button class="btn" onclick="get_game_info()">获取最新对局信息</button>
		<br>
		正在等待加入的对局
		<div id="game_info_content">
		</div>
	</div>
</div>


<script>
	var DEBUG = true;
	var only_one_undo = true;
	var canplace = false;
	var boardElement = document.querySelector(".tenuki-board");
	var game = new tenuki.Game(boardElement);
	game.setup();


	var string = 'abcdefghijklmnoprstuvwxyz';
	var game_started = 0;
	var side_me; // 记录我方黑白棋状态
	var now_side; //设置当前下棋的一方
    
    //每一次棋盘重绘之后都会执行下面的回调函数
    //即每次playAt后会执行
    //注意，每次悔棋(undo)也会执行下面的函数！！！！！
	game.callbacks.postRender = function(game) {

		console.log(game.currentState())
        //game.currentState() -- 游戏当前状态

		if (game.currentState().pass) {
			console.log(game.currentState().color + " passed");
		}

		if (game.currentState().playedPoint) {

			console.log(game.currentState().color + " played " + game.currentState().playedPoint.y + "," + game.currentState().playedPoint.x);
            /*
            *game.currentState().color--最近落子方
            *game.currentState().playedPoint.y，game.currentState().playedPoint.x 最近落子坐标
            *
            */
			var x = game.currentState().playedPoint.x;
			var y = game.currentState().playedPoint.y;


			if (game_started == 0)
			{
				game.undo();
				return;
			}
            //如果游戏还没有开始，此时落子后自动undo
			if (DEBUG)
			{
				console.log('能否落子(校验前):' + canplace);
			}
            //TODO 添加检验代码使得在非法情况下的落子可以被忽略
            
            //一个推荐的方法是使用undo
            
            //比较麻烦的原因是无论哪方落子都会触发该函数，并且该函数无法分辨落子
            //是由点击棋盘还是使用内置函数产生的
            //但是使用undo后也会触发该函数，需要额外的判断
            //

			/*if(canplace == false && only_one_undo)
			{
				//only_one_undo = false;
				console.log('当前不可落子');
				game.undo();
				return;
			}*/
            /*
			if(game.currentState().color != side_me)
			{
				if(canplace == false)
				{
					game.undo()
					return;
				}
			}
			else
			{
				canplace = false;
			}

			if (DEBUG)
			{
				console.log('能否落子(校验后):' + canplace);
			}
            */
            
            
            //下面是发送落子消息到服务端
			var msg;

			if (side_me == 'black')
			{
				msg='B';
			}
			else
			{
				msg='W';
			}
			msg += '[' +string[y] + string[x] + ']';

			sendmsg(msg);

		}
	};
/*
	function start_go(side)
	{
		game.setup({
			player: side,
			gameOptions: {
				boardSize: 19
			},
			hooks: {
				submitPlay: function(playedY, playedX, result) {
					if (side_me == 'black')
					{
						sendmsg('B[' + string[playedY] + string[playedX] + ']');
					}
					else
					{
						sendmsg('W[' + string[playedY] + string[playedX] + ']');
					}
					game._game.playAt(playedY, playedX);
				},

				submitMarkDeadAt: function(y, x, stones, result) {

				},

				submitPass: function(result) {

				}
			}
		});;
	}
*/




	function logout()
	{
		document.cookie="user_id=;";
		document.cookie="login=false;";
		window.location.reload();
		alert('logout');
	}
	

	function check_login(cookie)
	{

		if (cookie.match(/login=true/))
		{
			return true;
		}
		return false;
	}
	function get_user_id(cookies)
	{
		var i;
		for (i = 0; i < cookies.length; i++)
		{
			if (cookies[i].search('user_id') != -1)
			{
				var res = cookies[i].split('=')[1];
				return res;
			}
		}
	}
	function checkcookies(allcookies)
	{

		var cookies_list = allcookies.replace(" ", "").split(";");

		if (cookies_list.some(check_login))
		{
			$('#login_reg').css('display','none');
			$('#user_id_display').text(get_user_id(cookies_list))
			$('#user_id').val(get_user_id(cookies_list));
		}
		else
		{
			//alert('您尚未登录！请登录!');
			$('#user_information').css('display','none');

			//window.location.href = "/login";
		}
	}
	var socket = io.connect();

	$(document).ready(function ()
	{
		var allcookies = document.cookie;

		checkcookies(allcookies);
		socket.on('connect', function ()
		{
			//socket.emit('connect_event', {data: '连接成功'});
			console.log('连接成功');
		});
		socket.on('server_response', function (msg)
		{
			if (DEBUG)
			{
				console.log(msg);
			}
		});
	});
	socket.on('game_start', function (msg)
		{
			if (DEBUG)
			{
				console.log(msg)
			}
			if (msg.user_id == $('#user_id').val() && msg.begin == 0 && msg.game_id == $('#game_id').val())
			{
				console.log('成功创建游戏');
				alert('成功创建游戏，ID为:' + msg.game_id);
				side_me = msg.side;
				game_started = 0;

			}
			if (msg.game_id == $('#game_id').val() && msg.user_id != $('#user_id').val() && msg.begin == 1)
			{
				alert('另一个用户成功连接,游戏开始!');
				$('#gameinfo').text($('#user_id').val() + '(黑)和' + msg.user_id + '(白)的对决');
				$('div#player_side').text('你执黑棋');
				game_started = 1;
				now_side='black';
				side_me = 'black';

				canplace = true;
				//start_go('black');
				//game.setSide('black');
			}
			if (msg.game_id == $('#game_id').val() && msg.user_id == $('#user_id').val() && msg.begin == 1)
			{
				alert('成功连接游戏,游戏开始!');
				$('#gameinfo').text(msg.emeny + '(黑)和' + $('#user_id').val() + '(白)的对决');
				side_me = 'white';
				now_side = 'black';
				//start_go('white');
				game_started = 1;
				//game.setSide('white');
				canplace = false;
				$('div#player_side').text('你执白棋');

			}
		}
	);
	socket.on('start_error', function (msg)
	{
		if (DEBUG)
		{
			console.log(msg)
		}
		if (msg.game_id == $('#game_id').val())
		{
			alert('加入游戏失败,该游戏ID已被使用');
		}
	});
	socket.on('play_game_client', function (msg)
		{
			//alert('接受到信息');
			//game = eval('new Map(' + msg.data + ')');

			var game_msg = msg;
			if (game_msg.game_id == $('#game_id').val() && game_msg.user_id != $('#user_id').val())
			{
				var place = game_msg.msg;
				var letter_x = place.charAt(2);
				var letter_y = place.charAt(3);
				var n_x = string.indexOf(letter_x);
				var n_y = string.indexOf(letter_y);
				if(DEBUG)
				{
					console.log('收到落子消息')
					console.log(msg)
				}

				game.playAt(n_x,n_y);
				canplace = true;
				//game.receivePlay(n_x,n_y);

				setsystemmessage('敌方落子:[' + letter_x + ',' + letter_y + ']\n现在轮到我方落子');

				if (place.charAt(0) == 'B')
				{
					now_side = "white";
				}
				else
				{
					now_side = "black";
				}
				if(DEBUG)
				{
					console.log('改变当前势力');
					console.log(now_side);
				}


			}
		}
	);
	socket.on('game_info', function (msg)
	{
		if (DEBUG)
		{
			console.log(msg)
		}
		$('#game_info_content').html(msg.data);
	});
	//收到message
	socket.on('message', function (msg)
	{
		//只有game_id一致时才显示

		if (msg.game_id == $('#game_id').val())
		{
			setmessage(msg.user_id + ':' + msg.message);
			if (DEBUG)
			{
				console.log('收到聊天信息', msg)
			}
		}
	});

	//发送落子消息

	function sendmsg(msg)
	{
		if (DEBUG)
		{
			console.log('发送落子消息');
		}
		socket.emit('play_game_server', {user_id: $('#user_id').val(), game_id: $('#game_id').val(), msg: msg})
	}

	function get_game_info()
	{
		socket.emit('get_wait_game', {});
	}
	//发送用户id和对局id
	function submit_id()
	{
		if($('#user_id').val() == '')
		{
			alert('您还尚未登录,请登录后再操作!');
			return
		}

		if ($('#game_id').val() == '')
		{
			alert('必须输入游戏id');
		}
		else
		{
			console.log($('#user_id').val() + $('#game_id').val());
			socket.emit('game_start', {user_id: $('#user_id').val(), game_id: $('#game_id').val()});
		}
	}
	//发送对话消息
	$('form#sendmessage').submit(
		function submit_message()
		{
			if ($('#game_message').val() == '')
			{
				alert('不能发送空消息！');
			}
			else
			{
				socket.emit('message', {
					user_id: $('#user_id').val(),
					game_id: $('#game_id').val(),
					message: $('#game_message').val()
				});
			}
		}
	);
	//显示收到的消息，可以用更美观的方式实现
	//TODO
	function setmessage(msg)
	{
		$('div#gamemessage').append('<br>' + $('<div/>').text(msg).html());
	}
	function setsystemmessage(msg)
	{
		$('div#system_message').text(msg);
	}


</script>

</body>
</html>